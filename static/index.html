<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>PI Radio</title>

	<link rel="icon" href="favicon.png" />
	<link rel="stylesheet" href="index.css" />

	<script src="https://cdn.jsdelivr.net/npm/@tailwindplus/elements@1" type="module"></script>
</head>

<body class="text-sm bg-neutral-950 text-slate-50 select-none">
	<main class="flex flex-col">
		<div
			class="fixed flex items-center justify-between h-[64px] overflow-hidden gap-2 px-6 top-0 left-0 right-0 bg-neutral-950 border-b border-neutral-800">
			<div class="flex gap-2 items-center whitespace-nowrap">
				<img src="favicon.png" width="64" height="32" />
				<h1 class="font-semibold text-base leading-16">PI Radio</h1>
			</div>

			<form id="upload-form" enctype="multipart/form-data">
				<input type="file" id="file-input" name="files" multiple />
				<button type="submit">Upload</button>
			</form>
		</div>

		<div class="my-[64px] flex flex-col py-6 sm:px-12">
			<ul id="file-list" class="flex flex-col"></ul>

			<div id="stream-controls"
				class="fixed data-hidden:hidden bg-neutral-950 bottom-0 left-0 right-0 h-[64px] px-4 border-t border-neutral-800 flex gap-2 items-center mx-auto py-2">
				<button id="pause-button" onclick="togglePause()" data-hidden="true"
					class="rounded data-hidden:hidden size-8 flex items-center justify-center border border-neutral-800 bg-neutral-950 hover:bg-neutral-800 cursor-pointer">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
						stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
						class="lucide lucide-pause-icon lucide-pause">
						<rect x="14" y="3" width="5" height="18" rx="1" />
						<rect x="5" y="3" width="5" height="18" rx="1" />
					</svg>
				</button>

				<button id="unpause-button" onclick="togglePause()"
					class="rounded data-hidden:hidden size-8 flex items-center justify-center border border-neutral-800 bg-neutral-950 hover:bg-neutral-800 cursor-pointer">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
						stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
						class="lucide lucide-play-icon lucide-play">
						<path d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z" />
					</svg>
				</button>

				<h2 id="stream-file-name"></h2>

				<div class="flex items-center gap-2 ml-auto">
					<button id="volume-minus-button"
						class="data-hidden:hidden rounded size-8 border flex items-center justify-center border-neutral-800 bg-neutral-950 hover:bg-neutral-800 cursor-pointer">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
							class="lucide lucide-minus-icon lucide-minus">
							<path d="M5 12h14" />
						</svg>
					</button>
					<div id="volume-value">0</div>
					<button id="volume-plus-button"
						class="data-hidden:hidden rounded size-8 border flex items-center justify-center border-neutral-800 bg-neutral-950 hover:bg-neutral-800 cursor-pointer">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
							class="lucide lucide-plus-icon lucide-plus">
							<path d="M5 12h14" />
							<path d="M12 5v14" />
						</svg>
					</button>
				</div>

				<button id="stop-button"
					class="rounded size-8 border flex items-center justify-center border-neutral-800 bg-neutral-950 hover:bg-neutral-800 cursor-pointer">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
						stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
						class="lucide lucide-x-icon lucide-x">
						<path d="M18 6 6 18" />
						<path d="m6 6 12 12" />
					</svg>
				</button>
			</div>
		</div>
	</main>
</body>

</html>

<template id="file">
	<li class="flex gap-2 items-center py-1.5 px-6 hover:bg-neutral-900 rounded overflow-hidden">
		<div class="file-name truncate"></div>

		<div class="flex items-center gap-2 ml-auto">
			<el-dropdown class="text-slate-50">
				<button type="button" class="cursor-pointer flex items-center justify-center">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
						stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
						class="lucide lucide-ellipsis-vertical-icon lucide-ellipsis-vertical">
						<circle cx="12" cy="12" r="1" />
						<circle cx="12" cy="5" r="1" />
						<circle cx="12" cy="19" r="1" />
					</svg>
				</button>
				<el-menu anchor="bottom start" popover
					class="[--anchor-gap:4px] transition transition-discrete data-closed:opacity-0 data-enter:duration-75 data-enter:ease-out data-leave:duration-100 data-leave:ease-in bg-neutral-950 border border-neutral-800 text-slate-50 rounded p-1">
					<button class="file-play-button focus:bg-neutral-900 px-4 py-1 rounded cursor-pointer w-full" type="button">
						Play
					</button>
					<hr role="none" class="my-1 text-neutral-800" />
					<button class="file-delete-button focus:bg-neutral-900 px-4 py-1 rounded cursor-pointer w-full" type="button">
						Delete
					</button>
				</el-menu>
			</el-dropdown>
		</div>
	</li>
</template>

<script>
	const radioState = {
		stream_file: null,
		paused: true,
		volume: 0,
	};

	const fileList = document.getElementById("file-list");
	const fileTemplate = document.getElementById("file");

	const uploadForm = document.getElementById("upload-form");

	const volumeMinusButton = document.getElementById("volume-minus-button");
	const volumePlusButton = document.getElementById("volume-plus-button");

	const stopButton = document.getElementById("stop-button");

	const pauseButton = document.getElementById("pause-button");
	const unpauseButton = document.getElementById("unpause-button");

	const streamFileName = document.getElementById("stream-file-name");

	const streamControls = document.getElementById('stream-controls')

	async function handleStatusUpdate(status) {
		console.log(status);
		radioState.stream_file = status.stream_file;
		radioState.paused = status.paused;
		radioState.volume = status.volume;

		streamFileName.textContent = status.stream_file?.name ?? "";

		if (status.paused) {
			pauseButton.setAttribute("data-hidden", true);
			unpauseButton.removeAttribute("data-hidden");
		} else {
			pauseButton.removeAttribute("data-hidden");
			unpauseButton.setAttribute("data-hidden", true);
		}

		if (status.stream_file) {
			streamControls.removeAttribute("data-hidden");
		} else {
			streamControls.setAttribute("data-hidden", true);
		}
	}

	async function handleStop() {
		await fetch("/api/radio/stop", { method: "POST" });
		location.reload();
	}

	async function handlePlay(audioFileID) {
		await fetch(`/api/radio/play`, {
			method: "POST",
			body: JSON.stringify({ audio_file_id: audioFileID }),
		});
		location.reload();
	}

	async function togglePause() {
		radioState.paused = !radioState.paused;

		await fetch("/api/radio/pause", {
			method: "POST",
			body: JSON.stringify({ paused: radioState.paused }),
		});

		if (radioState.paused) {
			pauseButton.setAttribute("data-hidden", true);
			unpauseButton.removeAttribute("data-hidden");
		} else {
			pauseButton.removeAttribute("data-hidden");
			unpauseButton.setAttribute("data-hidden", true);
		}
	}

	fetch("/api/radio/files")
		.then((response) => response.json())
		.then((data) => {
			data.forEach((file) => {
				const clone = fileTemplate.content.cloneNode(true);

				clone.querySelector(".file-name").textContent = file.name;

				clone
					.querySelector(".file-play-button")
					.addEventListener("click", () => handlePlay(file.id));

				clone
					.querySelector(".file-delete-button")
					.addEventListener("click", async () => {
						const response = await fetch(`/api/radio/files/${file.id}`, {
							method: "DELETE",
						});
						if (response.ok) {
							location.reload();
						}
					});

				fileList.appendChild(clone);
			});
		})
		.catch((error) => console.error("Error fetching data:", error));

	fetch("/api/radio/status")
		.then((response) => response.json())
		.then(handleStatusUpdate);

	stopButton.addEventListener("click", handleStop);

	uploadForm.addEventListener("submit", async (event) => {
		event.preventDefault();

		const fileInput = document.getElementById("file-input");
		const files = fileInput.files;

		if (files.length === 0) {
			return;
		}

		const formData = new FormData();

		for (let i = 0; i < files.length; i++) {
			formData.append("files", files[i]);
		}

		const response = await fetch("/api/radio/files", {
			method: "POST",
			body: formData,
		});
		if (response.ok) {
			const data = await response.json();
			location.reload();
		}
	});
</script>